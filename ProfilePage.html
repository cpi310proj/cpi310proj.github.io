<!DOCTYPE html>
<html>
<head>
<title>My Rad Page</title>

<script type='text/javascript' src='handlebars-v4.0.5.js'></script>

 <script src="https://www.gstatic.com/firebasejs/3.6.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBybzQ7A9ivNxUvOI03rbFXOS6UVnEAszk",
    authDomain: "test-1cc17.firebaseapp.com",
    databaseURL: "https://test-1cc17.firebaseio.com",
    storageBucket: "test-1cc17.appspot.com",
    messagingSenderId: "376566074849"
  };
  firebase.initializeApp(config);
</script>


<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="w3.css">
<link rel="stylesheet" href="w3-theme-black.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
html,body,h1,h2,h3,h4,h5 {font-family: "Raleway", sans-serif}
</style>
</head>
<body onload="onload(); randomMessage();" class="w3-theme-l5">

<!-- Navbar -->
<div class="w3-top">
 <ul class="w3-navbar w3-theme-d2 w3-left-align  w3-large">
  <li class="w3-hide-medium w3-hide-large w3-opennav w3-right">
    <a class="w3-padding-large w3-hover-white w3-large w3-theme-d2" href="javascript:void(0);" onclick="openNav()"><i class="fa fa-bars"></i></a>
  </li>
  <li><a href="ProfilePage.html" class="w3-padding-large w3-hover-white w3-theme-d4"><i class="fa fa-home w3-margin-right"></i>RAD PAGES &#x270C</a></li>
  <li class="w3-hide-small"><a href="All.html" class="w3-padding-large w3-hover-white" title="'Sup world?"><i class="fa fa-globe"></i></a></li>
  <li class="w3-hide-small"><a href="AccountSettings.html" class="w3-padding-large w3-hover-white" title="Change up ur Settings"><i class="fa fa-user"></i></a></li>
  <li class="w3-hide-small"><a onclick="logout()" href="index.html" class="w3-padding-large w3-hover-white" title="L84 bro!"><i class="fa fa-times"></i></a></li>
 </ul>
</div>

<!-- Navbar on small screens -->
<div id="navDemo" class="w3-hide w3-hide-large w3-hide-medium w3-top" style="margin-top:51px">
  <ul class="w3-navbar w3-left-align w3-large w3-theme">
    <li><a class="w3-padding-large" href="All.html">Fresh Posts On The Word Stage</a></li>
    <li><a class="w3-padding-large" href="AccountSettings.html">Mess with your profile</a></li>
    <li><a class="w3-padding-large" href="ProfilePage.html">My Rad Page</a></li>
    <li><a class="w3-padding-large" href="index.html">Peace out dude!</a></li>
  </ul>
</div>

<!-- Page Container -->
<div class="w3-container w3-content" style="max-width:1400px;margin-top:80px">
  <!-- The Grid -->
  <div class="w3-row">
    <!-- Left Column -->
    <div class="w3-col m3">
      <!-- Profile -->
      <div class="w3-card-2 w3-round w3-white">
        <div class="w3-container">
         <h4 id="screenName" class="w3-center"></h4>
         <p class="w3-center"><img id="profileView" src="" class="w3-circle" style="height:106px;width:106px" alt="Avatar"></p>
         <hr>
         <p id="jobLabel"><i class="fa fa-pencil fa-fw w3-margin-right w3-text-theme"></i></p>
         <p id="locationLabel"><i class="fa fa-home fa-fw w3-margin-right w3-text-theme"></i></p>
         <p id="birthdayLabel"><i class="fa fa-birthday-cake fa-fw w3-margin-right w3-text-theme"></i></p>
        </div>
      </div>
      <br>



      <!-- Alert Box -->
      <div class="w3-container w3-round w3-theme-l4 w3-border w3-theme-border w3-margin-bottom w3-hide-small">
        <span onclick="this.parentElement.style.display='none'" class="w3-hover-text-grey w3-closebtn">
          <i class="fa fa-remove"></i>
        </span>
        <p id="greeting"></p>
        <p id="message"></p>
      </div>

    <!-- End Left Column -->
    </div>

    <!-- Middle Column -->
    <div class="w3-col m7">

      <div id="midColumn" class="w3-row-padding">
        <div class="w3-col m12">
          <div class="w3-card-2 w3-round w3-white">
            <div class="w3-container w3-padding">
              <h6 class="w3-opacity">Make a fresh post!</h6>
              <p id="postText" contenteditable="true" class="w3-border w3-padding"></p>
              <button onclick="newPost()" type="button" class="w3-btn w3-theme"><i class="fa fa-pencil"></i>  Post</button>
            </div>
          </div>
        </div>
      </div>

    <!-- End Middle Column -->
    </div>

    <!-- Right Column -->
    <div class="w3-col m2">
      <div class="w3-card-2 w3-round w3-white w3-center">
        <div class="w3-container">
          <p>SoundCloud</p>
		  <!--Change this line below to the embedd code when submit button is pressed -->
        <div id="soundcloud">
          <!-- <iframe width="100%" height="450" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/19265449&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe> -->
        </div>
          <p><strong>Import your own Soundcloud playlist!</strong></p>
        <form class="w3-container">
<label>SoundCloud Embedd Code</label>
<input id="newEmbed" class="w3-input" type="text">
<button onclick="updateSoundcloud()" class="w3-btn w3-black">Submit</button>
</form>
        </div>
      </div>
      <br>



    <!-- End Right Column -->
    </div>

  <!-- End Grid -->
  </div>

<!-- End Page Container -->
</div>
<br>

<!-- Footer -->
<footer class="w3-container w3-theme-d3 w3-padding-16">
  <h5>2K16 Rad Pages</h5>
</footer>

<script id="post-template" type="text/x-handlebars-template">
<div class="w3-container w3-card-2 w3-white w3-round w3-margin"><br>
  <span class="w3-right w3-opacity"></span>
  <h4>{{content}}</h4>
  <hr class="w3-clear">
  <p>{{dateString}}</p>
  <button type="button" class="w3-btn w3-theme-d1 w3-margin-bottom"><i class="fa fa-thumbs-up"></i>  Like</button>
  <p class="w3-right w3-margin-left">{{likeCount}}</p>
</div>
</script>

<script id="post-template-liked" type="text/x-handlebars-template">
<div class="w3-container w3-card-2 w3-white w3-round w3-margin"><br>
  <span class="w3-right w3-opacity"></span>
  <h4>{{content}}</h4>
  <hr class="w3-clear">
  <p>{{dateString}}</p>
  <button type="button" disabled class="w3-btn w3-theme-d1 w3-margin-bottom"><i class="fa fa-thumbs-up"></i>  Like</button>
  <p class="w3-right w3-margin-left">{{likeCount}}</p>
</div>
</script>



<script>


//random message
function randomMessage() {

	var randomNum1 = Math.floor((Math.random() * 10) + 1);
	var randomNum2 = Math.floor((Math.random() * 10) + 1);
	var message = document.getElementById('message');
	var greeting = document.getElementById('greeting');
	
	if (randomNum1 <= 2) {
		message.innerHTML = "What's up??";
	}
	else if (randomNum1 > 2 && randomNum1 <= 6) {
		message.innerHTML = "Heyyyyyyy";
	}
	else if (randomNum1 > 6 && randomNum1 <= 8) {
		message.innerHTML = "How you doin'?";
	}
	else if (randomNum1 > 8 && randomNum1 <= 10) {
		message.innerHTML = "Welcome back to Rad Pages!";
	}
	else {
		message.innerHTML = "it broke";
	}
	
	if (randomNum2 <= 2) {
		greeting.innerHTML = "Aye!";
	}
	else if (randomNum2 > 2 && randomNum2 <= 6) {
		greeting.innerHTML = "Yo!";
	}
	else if (randomNum2 > 6 && randomNum2 <= 8) {
		greeting.innerHTML = "'Sup";
	}
	else if (randomNum2 > 8 && randomNum2 <= 10) {
		greeting.innerHTML = "Duuuuude,";
	}
	else {
		greeting.innerHTML = "it broke";
	}

}
// Accordion

function onload() {
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {

      var photoView = document.getElementById("profileView");
      var nameLabel = document.getElementById("screenName");
      var locationLabel = document.getElementById("locationLabel");
      var jobLabel = document.getElementById("jobLabel");
      var birthdayLabel = document.getElementById("birthdayLabel");
      var soundcloudDiv = document.getElementById("soundcloud");


    loadPosts();
    firebase.database().ref('/users/' + user.uid).once('value').then(function(snapshot) {
      var location = snapshot.val().location;
      var occupation = snapshot.val().occupation;
      var birthday = snapshot.val().birthday;
      var displayName = snapshot.val().displayName;
      var photoUrl = snapshot.val().photoURL;
      var soundcloudHtml = snapshot.val().soundcloud;

      profileView.src = photoUrl;

      soundcloudDiv.insertAdjacentHTML('beforeend', soundcloudHtml);

      if(displayName == null || displayName == "") {
        nameLabel.innerHTML = "My Profile"
      }
      else {
        nameLabel.innerHTML = displayName;
      }

      var locationNode;
      if(location == null || location == "") {
        locationNode = document.createTextNode(" Set your location");
      }
      else {
        locationNode = document.createTextNode(location);
      }
      locationLabel.appendChild(locationNode);

      var jobNode;
      if(occupation == null || occupation == "") {
        jobNode = document.createTextNode(" Set your occupation");
      }
      else {
        jobNode = document.createTextNode(occupation);
      }
      jobLabel.appendChild(jobNode);

      var birthdayNode;
      if(birthday == null || birthday == "") {
        birthdayNode = document.createTextNode(" Set your birthday");
      }
      else {
        birthdayNode = document.createTextNode(birthday);
      }
      birthdayLabel.appendChild(birthdayNode);
    });
  } else {
    window.location.assign("https://cpi310proj.github.io/index");
  }
  });
}

function updateSoundcloud() {
  var html = document.getElementById("newEmbed").value;

  if(html != "") {
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
          var updates = {};
          var ref = "users/" + user.uid + "/soundcloud";
          updates[ref] = html;
          firebase.database().ref().update(updates);
          window.location.assign("https://cpi310proj.github.io/ProfilePage");
      }
    });
  }
}

function newPost() {
    var text = document.getElementById("postText").innerHTML;
    if(text == "") {
      return;
    }

    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
          var updates = {};
          var newRef = firebase.database().ref("users/" + user.uid + "posts/").push();
          var key = newRef.key;
          var userRef = "users/" + user.uid + "/posts/" + key + "/";
          var postRef = "posts/" + key + "/";

          var time = Date.now();
          updates[userRef + "timestamp"] = time;
          updates[userRef + "liked"] = false;
          updates[postRef + "text"] = text;
          updates[postRef + "posterId"] = user.uid;
          updates[postRef + "likes"] = 0;
          updates[postRef + "timestamp"] = time;


          firebase.database().ref().update(updates);
          window.location.assign("https://cpi310proj.github.io/ProfilePage");
      }
      else {
          alert("not logged in");
      }
    });
}

function loadPosts() {
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      var postRef = firebase.database().ref('users/' + user.uid + "/posts/").orderByChild('timestamp');
      postRef.on('child_added', function(data) {
        generatePostHtml(data.key, data.val().liked, data.val().timestamp);
      });
    }
  });
}

function logout() {
  firebase.auth().signOut().then(function() {
    // Sign-out successful.
  }, function(error) {
    // An error happened.
  });
}

function generatePostHtml(postId, isLiked, timestamp) {

  firebase.database().ref('/posts/' + postId).once('value').then(function(snapshot) {
    var text = snapshot.val().text;
    var likes = snapshot.val().likes;
    var date = new Date(timestamp).toDateString();

    var source;
    if(isLiked) {
      source = document.getElementById("post-template-liked").innerHTML;
    }
    else {
      source = document.getElementById("post-template").innerHTML;
    }

    var template = Handlebars.compile(source);
    var context = {content: text, likeCount: likes, dateString: date};

    var parent = document.getElementById("midColumn");
    parent.insertAdjacentHTML('afterend', template(context));
  });


}

function myFunction(id) {
    var x = document.getElementById(id);
    if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
        x.previousElementSibling.className += " w3-theme-d1";
    } else {
        x.className = x.className.replace("w3-show", "");
        x.previousElementSibling.className =
        x.previousElementSibling.className.replace(" w3-theme-d1", "");
    }
}

// Used to toggle the menu on smaller screens when clicking on the menu button
function openNav() {
    var x = document.getElementById("navDemo");
    if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
    } else {
        x.className = x.className.replace(" w3-show", "");
    }
}
</script>

</body>
</html>
